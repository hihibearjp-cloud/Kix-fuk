<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA & iOS Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Âêâ‰ºäÊâãÂ∏≥">
    <meta name="theme-color" content="#fdfbf7">
    <meta name="format-detection" content="telephone=no">
    
    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/kawaii-dinosaur.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/192/kawaii-dinosaur.png">

    <!-- Embedded Manifest for PWA -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuWkj+S8iuaJi+W4syIsCiAgInNob3J0X25hbWUiOiAi5aSP5LyK5omL5bizIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZGZiZjciLAogICJ0aGVtZV9jb2xvciIjogIiNmZGZiZjciLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImh0dHBzOi8vaW1nLmljb25zOC5jb20vY29sb3IvMTkyL2thd2FpaS1kaW5vc2F1ci5wbmciLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogIH1dCn0=">

    <title>Âêâ‰ºäÂç°ÂìáÊóÖ‰∫∫ÊâãÂ∏≥</title>
    
    <!-- CSS Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Core Engine -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* iOS App-like Behavior */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            height: 100vh;
            overflow: hidden;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root">
        <!-- Loading State -->
        <div style="height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #888;">
            <div class="spinner" style="margin-bottom: 20px;"></div>
            <div style="font-size: 18px; font-weight: bold;">Ê≠£Âú®ÂïüÂãïÂêâ‰ºäÊâãÂ∏≥...</div>
            <div style="font-size: 12px; margin-top: 10px;">‰øÆÊ≠£ÁâàÊú¨ËºâÂÖ•‰∏≠</div>
        </div>
    </div>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="padding: 40px; color: #e11d48; font-family: sans-serif; text-align: center;">
                    <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">ÂìéÂëÄÔºÅÁôºÁîüÈåØË™§‰∫Ü (¬¥;œâ;\`)</h2>
                    <p style="color: #666; margin-bottom: 20px;">Ë´ãÊà™ÂúñÊ≠§Áï´Èù¢‰∏¶ÂõûÂ†±Ôºö</p>
                    <div style="background: #fff1f2; padding: 15px; border-radius: 12px; border: 1px solid #fecdd3; text-align: left; font-family: monospace; font-size: 12px; overflow: auto;">
                        ${msg}<br>Line: ${line}:${col}
                    </div>
                    <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 24px; background: #888; color: white; border: none; border-radius: 20px; font-weight: bold;">ÈáçÊñ∞Êï¥ÁêÜ</button>
                </div>
            `;
            return false;
        };
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- App Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // FIXME: Renamed Map to MapIcon to avoid conflict with global Map constructor
        import { 
            Plus, Trash2, Wallet, CreditCard, Download, Smartphone, Train, 
            ShoppingBag, Users, X, CheckCircle, MapPin, Heart, 
            Edit2, Save, Sparkles, Camera, Wand2, Share, 
            Image as ImageIcon, Loader2, Settings, Calculator,
            ChevronLeft, ChevronRight, Map as MapIcon, AlertTriangle, Upload, FileJson
        } from 'lucide-react';

        // --- Configuration ---
        const DB_PREFIX = 'chiikawa_app_';
        const apiKey = ""; 

        // --- Storage Engine (Local) ---
        const getStore = (key) => {
            try { return JSON.parse(localStorage.getItem(key) || '[]'); } 
            catch { return []; }
        };
        const setStore = (key, val) => localStorage.setItem(key, JSON.stringify(val));
        
        // --- Event System for Reactivity ---
        // This line caused the error before because 'Map' was shadowed by the icon component
        const listeners = new Map(); 
        
        const notify = (key) => {
            if (!listeners.has(key)) return;
            const data = key.includes('settings') 
                ? JSON.parse(localStorage.getItem(key) || '{}') 
                : getStore(key); 
            
            let snap;
            if (Array.isArray(data)) {
                snap = { docs: data.map(d => ({ id: d.id, data: () => d, ...d })) };
            } else {
                snap = { exists: () => true, data: () => data };
            }
            listeners.get(key).forEach(cb => cb(snap));
        };

        // --- Mock Firebase Interface ---
        const db = {};
        const collection = (db, ...paths) => {
            const colName = paths[paths.length - 1]; 
            return { type: 'collection', key: `${DB_PREFIX}${colName}` };
        };
        const doc = (db, ...paths) => {
            const id = paths[paths.length - 1];
            const colName = paths[paths.length - 2];
            if (colName === 'settings' && id === 'config') return { type: 'doc', key: `${DB_PREFIX}settings`, id };
            return { type: 'doc', key: `${DB_PREFIX}${colName}`, id };
        };
        const onSnapshot = (ref, callback) => {
            if (!listeners.has(ref.key)) listeners.set(ref.key, []);
            listeners.get(ref.key).push(callback);
            notify(ref.key); 
            return () => {
                const list = listeners.get(ref.key) || [];
                listeners.set(ref.key, list.filter(cb => cb !== callback));
            };
        };
        const addDoc = async (ref, data) => {
            const list = getStore(ref.key);
            const newItem = { ...data, id: crypto.randomUUID(), createdAt: new Date().toISOString() };
            list.push(newItem);
            setStore(ref.key, list);
            notify(ref.key);
            return { id: newItem.id };
        };
        const updateDoc = async (ref, data) => {
            if (ref.key.includes('settings')) {
                const current = JSON.parse(localStorage.getItem(ref.key) || '{}');
                localStorage.setItem(ref.key, JSON.stringify({ ...current, ...data }));
            } else {
                const list = getStore(ref.key);
                const idx = list.findIndex(i => i.id === ref.id);
                if (idx !== -1) {
                    list[idx] = { ...list[idx], ...data };
                    setStore(ref.key, list);
                }
            }
            notify(ref.key);
        };
        const deleteDoc = async (ref) => {
            const list = getStore(ref.key);
            const newList = list.filter(i => i.id !== ref.id);
            setStore(ref.key, newList);
            notify(ref.key);
        };
        const setDoc = async (ref, data, options) => {
            if (ref.key.includes('daily_photos')) {
                const list = getStore(ref.key);
                const idx = list.findIndex(i => i.id === ref.id);
                const newItem = { ...data, id: ref.id };
                if (idx !== -1) list[idx] = { ...list[idx], ...data };
                else list.push(newItem);
                setStore(ref.key, list);
            } else if (ref.key.includes('settings')) {
                const current = JSON.parse(localStorage.getItem(ref.key) || '{}');
                const merged = options?.merge ? { ...current, ...data } : data;
                localStorage.setItem(ref.key, JSON.stringify(merged));
            }
            notify(ref.key);
        };
        const query = (ref) => ref; 
        const orderBy = () => {}; 
        const serverTimestamp = () => new Date().toISOString();

        // --- Defaults ---
        const DEFAULT_CURRENCIES = [
            { code: 'TWD', label: 'Âè∞Âπ£', symbol: 'NT$', flag: 'üáπüáº', rate: 1 },
            { code: 'JPY', label: 'Êó•Âπ£', symbol: '¬•', flag: 'üáØüáµ', rate: 0.215 },
            { code: 'USD', label: 'ÁæéÂÖÉ', symbol: '$', flag: 'üá∫üá∏', rate: 32.5 },
        ];
        const DEFAULT_PAYMENT_METHODS = [
            { id: 'cash', name: 'ÁèæÈáë', iconName: 'Wallet' },
            { id: 'fubon_j', name: 'ÂØåÈÇ¶ J Âç°', iconName: 'CreditCard' },
            { id: 'apple_pay', name: 'Apple Pay', iconName: 'Smartphone' },
            { id: 'suica', name: 'Ë•øÁìúÂç°', iconName: 'Train' },
        ];
        const DEFAULT_DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'];

        // --- Components ---
        const TabButton = ({ id, label, icon: Icon, activeTab, setActiveTab, mainColor }) => (
            <button 
                onClick={() => setActiveTab(id)} 
                className={`flex-1 flex flex-col items-center justify-center py-2 px-1 transition-all duration-300 rounded-xl mx-1 border-2 ${activeTab === id ? `${mainColor} bg-white border-current shadow-md transform -translate-y-1` : 'border-transparent text-gray-400 hover:bg-white/50'}`}
            >
                <Icon size={24} strokeWidth={activeTab === id ? 3 : 2} className="mb-0.5"/>
                <span className="text-xs font-bold">{label}</span>
            </button>
        );

        function App() {
            const [user] = useState({ uid: 'local_traveler' });
            const [activeTab, setActiveTab] = useState('accounting');
            
            // Settings
            const [currencies, setCurrencies] = useState(DEFAULT_CURRENCIES);
            const [paymentMethods, setPaymentMethods] = useState(DEFAULT_PAYMENT_METHODS);
            const [tripDays, setTripDays] = useState(DEFAULT_DAYS);
            const [totalBudget, setTotalBudget] = useState(50000);

            // Inputs
            const [newPaymentName, setNewPaymentName] = useState('');
            const [newCurrencyCode, setNewCurrencyCode] = useState('');
            const [newCurrencyRate, setNewCurrencyRate] = useState('');

            // Data
            const [transactions, setTransactions] = useState([]);
            const [shoppingList, setShoppingList] = useState([]);
            const [schedule, setSchedule] = useState([]);
            const [dailyPhotos, setDailyPhotos] = useState({});

            // Form
            const [amount, setAmount] = useState('');
            const [description, setDescription] = useState('');
            const [type, setType] = useState('expense');
            const [currency, setCurrency] = useState('JPY'); 
            const [paymentMethod, setPaymentMethod] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [usageType, setUsageType] = useState('self');
            const [targetName, setTargetName] = useState('');
            
            // Schedule Form
            const [scheduleDay, setScheduleDay] = useState('Day 1');
            const [dayViewStartIndex, setDayViewStartIndex] = useState(0);
            const [newEventTitle, setNewEventTitle] = useState('');
            const [newEventTime, setNewEventTime] = useState('');
            const [newEventLocation, setNewEventLocation] = useState('');
            const [editingEventId, setEditingEventId] = useState(null);

            // Modals
            const [showSettlementModal, setShowSettlementModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [showScheduleImportModal, setShowScheduleImportModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showCalculatorModal, setShowCalculatorModal] = useState(false);
            const [showInstallGuide, setShowInstallGuide] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: () => {} });

            // Tools
            const [importText, setImportText] = useState('');
            const [scheduleImportText, setScheduleImportText] = useState('');
            const [scheduleImportTargetDay, setScheduleImportTargetDay] = useState('Day 1');
            const [isAnalyzingImage, setIsAnalyzingImage] = useState(false);
            const fileInputRef = useRef(null);
            const photoInputRef = useRef(null); 
            const dataImportInputRef = useRef(null);
            const [calcAmount, setCalcAmount] = useState('');
            const [calcRate, setCalcRate] = useState('0.215');

            // --- Effects ---
            useEffect(() => {
                document.documentElement.style.fontSize = '17px'; 
                setScheduleDay(tripDays[0]);
            }, []);

            useEffect(() => {
                const appId = 'local-app'; 
                
                const unsubTrx = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions')), snap => 
                    setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>new Date(b.date)-new Date(a.date)))
                );
                
                const unsubShop = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'shopping_list'), snap => 
                    setShoppingList(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>(a.isBought===b.isBought?0:a.isBought?1:-1)))
                );
                
                const unsubSch = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule')), snap => 
                    setSchedule(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.time.localeCompare(b.time)))
                );
                
                const unsubPhotos = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'daily_photos'), snap => {
                    const photos = {};
                    snap.docs.forEach(doc => photos[doc.id] = doc.data().image);
                    setDailyPhotos(photos);
                });

                const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists() && Object.keys(docSnap.data()).length > 0) {
                        const data = docSnap.data();
                        if (data.currencies) setCurrencies(data.currencies);
                        if (data.paymentMethods) setPaymentMethods(data.paymentMethods);
                        if (data.tripDays) setTripDays(data.tripDays);
                        if (data.totalBudget) setTotalBudget(data.totalBudget);
                        setPaymentMethod(prev => prev || (data.paymentMethods?.length > 0 ? data.paymentMethods[0].id : ''));
                        setCurrency(prev => prev || (data.currencies?.length > 0 ? data.currencies[0].code : ''));
                    } else {
                        setDoc(settingsRef, { currencies: DEFAULT_CURRENCIES, paymentMethods: DEFAULT_PAYMENT_METHODS, tripDays: DEFAULT_DAYS, totalBudget: 50000 }, { merge: true });
                        setPaymentMethod(DEFAULT_PAYMENT_METHODS[0].id);
                    }
                });

                return () => { unsubTrx(); unsubShop(); unsubSch(); unsubSettings(); unsubPhotos(); };
            }, [user]);

            // --- Handlers ---
            const fileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            const getCurrencySymbol = (code) => currencies.find(c => c.code === code)?.symbol || '$';
            const saveSettings = async (newConfig) => {
                await setDoc(doc(db, 'artifacts', 'local-app', 'users', user.uid, 'settings', 'config'), newConfig, { merge: true });
            };
            
            // Payment Methods
            const handleAddPaymentMethod = () => {
                if (newPaymentName.trim()) {
                    const newMethods = [...paymentMethods, { id: crypto.randomUUID(), name: newPaymentName, iconName: 'CreditCard' }];
                    setPaymentMethods(newMethods);
                    saveSettings({ paymentMethods: newMethods });
                    setNewPaymentName('');
                }
            };
            const handleDeletePaymentMethod = (id) => {
                if (paymentMethods.length <= 1) return alert("Ëá≥Â∞ëË¶ÅÁïô‰∏ÄÂÄãÔºÅ");
                if (!window.confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) return;
                const newMethods = paymentMethods.filter(p => p.id !== id);
                setPaymentMethods(newMethods);
                saveSettings({ paymentMethods: newMethods });
                if (paymentMethod === id) setPaymentMethod(newMethods[0].id);
            };

            // Currencies
            const handleAddCurrency = () => {
                if (newCurrencyCode.trim()) {
                    const code = newCurrencyCode.toUpperCase();
                    const rate = parseFloat(newCurrencyRate) || 1;
                    const newCurrencies = [...currencies, { code, label: code, symbol: '$', flag: 'üåç', rate }];
                    setCurrencies(newCurrencies);
                    saveSettings({ currencies: newCurrencies });
                    setNewCurrencyCode('');
                    setNewCurrencyRate('');
                }
            };
            const handleDeleteCurrency = (code) => {
                if (currencies.length <= 1) return alert("Ëá≥Â∞ëË¶ÅÁïô‰∏ÄÁ®ÆÂπ£Âà•ÔºÅ");
                if (!window.confirm(`Á¢∫ÂÆöÂà™Èô§ ${code}Ôºü`)) return;
                const newCurrencies = currencies.filter(c => c.code !== code);
                setCurrencies(newCurrencies);
                saveSettings({ currencies: newCurrencies });
                if (currency === code) setCurrency(newCurrencies[0].code);
            };

            // Days
            const handleAddDay = () => {
                const lastDay = tripDays[tripDays.length - 1] || 'Day 0'; 
                const lastNum = parseInt(lastDay.replace('Day ', '')) || tripDays.length;
                const newDays = [...tripDays, `Day ${lastNum + 1}`];
                setTripDays(newDays);
                saveSettings({ tripDays: newDays });
                if (newDays.length > 3) setDayViewStartIndex(newDays.length - 3);
                setScheduleDay(newDays[newDays.length - 1]);
            };
            const handleDeleteCurrentDay = () => {
                if (tripDays.length <= 1) return alert("Ëá≥Â∞ëË¶Å‰øùÁïô‰∏ÄÂ§©ÔºÅ");
                if (!window.confirm(`Á¢∫ÂÆöÂà™Èô§ ${scheduleDay}ÔºüË°åÁ®ã‰πüÊúÉÊ∂àÂ§±ÂñîÔºÅ`)) return;
                const newDays = tripDays.filter(d => d !== scheduleDay);
                setTripDays(newDays);
                setScheduleDay(newDays[0]);
                setDayViewStartIndex(0);
                saveSettings({ tripDays: newDays });
            };

            // Transactions
            const handleAddTransaction = async (e, linkedId = null) => {
                if(e) e.preventDefault();
                if (!amount || !description || !user) return;
                try {
                    await addDoc(collection(db, 'artifacts', 'local-app', 'users', user.uid, 'transactions'), {
                        amount: parseFloat(amount), description, type, currency, paymentMethod, date, usageType,
                        targetName: usageType === 'self' ? 'Ëá™Áî®' : (targetName || 'Êú™Áü•'), createdAt: serverTimestamp()
                    });
                    if (linkedId) await updateDoc(doc(db, 'artifacts', 'local-app', 'users', user.uid, 'shopping_list', linkedId), { isBought: true, boughtAt: serverTimestamp() });
                    setAmount(''); setDescription(''); if (usageType === 'help_buy') setTargetName('');
                } catch (err) { console.error(err); }
            };

            // Schedule
            const handleScheduleSubmit = async (e) => {
                e.preventDefault();
                if (!newEventTitle || !user) return;
                const data = { day: scheduleDay, time: newEventTime || '00:00', title: newEventTitle, location: newEventLocation, createdAt: serverTimestamp() };
                if (editingEventId) { await updateDoc(doc(db, 'artifacts', 'local-app', 'users', user.uid, 'schedule', editingEventId), { time: data.time, title: data.title, location: data.location }); setEditingEventId(null); } 
                else { await addDoc(collection(db, 'artifacts', 'local-app', 'users', user.uid, 'schedule'), data); }
                setNewEventTitle(''); setNewEventLocation(''); setNewEventTime('');
            };

            // Images
            const handleUploadCoverPhoto = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                if (file.size > 2 * 1024 * 1024) { alert("ÂúñÁâáÂ§™Â§ß‰∫ÜÔºÅË´ãÈÅ∏Áî® 2MB ‰ª•‰∏ãÁöÑÂúñÁâá„ÄÇ"); return; }
                const reader = new FileReader();
                reader.onload = async () => {
                    try { await setDoc(doc(db, 'artifacts', 'local-app', 'users', user.uid, 'daily_photos', scheduleDay), { image: reader.result }); } 
                    catch(e) { alert("ÂÑ≤Â≠òÂ§±ÊïóÔºåÁ©∫Èñì‰∏çË∂≥"); }
                };
                reader.readAsDataURL(file);
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                setIsAnalyzingImage(true);
                try {
                    const base64Data = await fileToBase64(file);
                    if (!apiKey) { alert("Ë´ãÂÖàË®≠ÂÆö API Key ÊâçËÉΩ‰ΩøÁî® AI Ëæ®Ë≠ò"); setIsAnalyzingImage(false); return; }
                    const prompt = `Analyze this itinerary image. Return JSON array of objects: [{"time": "HH:MM", "title": "Activity"}]. Estimate time if missing. Return ONLY JSON.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }] })
                    });
                    const result = await response.json();
                    let text = result.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const events = JSON.parse(text);
                    await Promise.all(events.map(ev => addDoc(collection(db, 'artifacts', 'local-app', 'users', user.uid, 'schedule'), { day: scheduleImportTargetDay, time: ev.time||'00:00', title: ev.title||'Êñ∞Ë°åÁ®ã', location: '', createdAt: serverTimestamp() })));
                    setShowScheduleImportModal(false); setScheduleDay(scheduleImportTargetDay);
                } catch (error) { console.error(error); alert("Ëæ®Ë≠òÂ§±Êïó"); } 
                finally { setIsAnalyzingImage(false); if(fileInputRef.current) fileInputRef.current.value = ''; }
            };

            // Backup/Restore
            const handleExportData = () => {
                const dataToExport = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(DB_PREFIX)) dataToExport[key] = localStorage.getItem(key);
                }
                const blob = new Blob([JSON.stringify(dataToExport)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Âêâ‰ºäÊâãÂ∏≥ÂÇô‰ªΩ_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (Object.keys(importedData).length === 0) throw new Error("Empty");
                        Object.keys(importedData).forEach(key => {
                            if (key.startsWith(DB_PREFIX)) localStorage.setItem(key, importedData[key]);
                        });
                        alert("ÈÇÑÂéüÊàêÂäüÔºÅÁ∂≤È†ÅÂ∞áÈáçÊñ∞Êï¥ÁêÜ„ÄÇ");
                        window.location.reload();
                    } catch (error) { alert("Ê™îÊ°àÊ†ºÂºèÈåØË™§ÊàñÊêçÊØÄ"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            // --- Computed ---
            const stats = useMemo(() => {
                const res = {}; currencies.forEach(c => res[c.code] = { bal: 0, symbol: c.symbol, flag: c.flag });
                transactions.forEach(t => { if(!res[t.currency]) res[t.currency] = { bal: 0, symbol: '$', flag: '?' }; res[t.currency].bal += t.type === 'income' ? t.amount : -t.amount; });
                return res;
            }, [transactions, currencies]);

            const budgetStatus = useMemo(() => {
                let totalSpentTWD = 0;
                transactions.forEach(t => {
                    if (t.type === 'expense' && t.usageType === 'self') {
                        const rate = currencies.find(c => c.code === t.currency)?.rate || 1;
                        totalSpentTWD += t.amount * rate;
                    }
                });
                const percent = Math.min(100, Math.max(0, (totalSpentTWD / totalBudget) * 100));
                return { totalSpentTWD, percent, remaining: totalBudget - totalSpentTWD };
            }, [transactions, totalBudget, currencies]);

            const settlement = useMemo(() => {
                const p = {}; transactions.filter(t => t.usageType === 'help_buy').forEach(t => { if(!p[t.targetName]) p[t.targetName] = {}; if(!p[t.targetName][t.currency]) p[t.targetName][t.currency] = 0; p[t.targetName][t.currency] += t.amount; });
                return p;
            }, [transactions]);

            const visibleDays = useMemo(() => {
                const maxStart = Math.max(0, tripDays.length - 3);
                const safeStart = Math.min(dayViewStartIndex, maxStart);
                return tripDays.slice(safeStart, safeStart + 3);
            }, [tripDays, dayViewStartIndex]);

            // --- Sub-Component: Budget Ring ---
            const BudgetRing = () => {
                const radius = 35;
                const circumference = 2 * Math.PI * radius;
                const strokeDashoffset = circumference - (budgetStatus.percent / 100) * circumference;
                const color = budgetStatus.percent > 90 ? 'text-red-500' : budgetStatus.percent > 70 ? 'text-yellow-500' : 'text-green-500';
                return (
                    <div className="bg-white p-5 rounded-3xl shadow-sm border-2 border-gray-100 flex items-center justify-between mb-4">
                        <div className="flex items-center space-x-5">
                            <div className="relative w-20 h-20 flex items-center justify-center">
                                <svg className="w-full h-full transform -rotate-90">
                                    <circle cx="40" cy="40" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" className="text-gray-100" />
                                    <circle cx="40" cy="40" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} className={`${color} transition-all duration-1000 ease-out`} strokeLinecap="round" />
                                </svg>
                                <span className={`absolute text-sm font-black ${color}`}>{Math.round(budgetStatus.percent)}%</span>
                            </div>
                            <div>
                                <div className="text-sm text-gray-400 font-bold uppercase tracking-wider mb-1">È†êÁÆóÂâ©È§ò</div>
                                <div className={`text-2xl font-black ${budgetStatus.remaining < 0 ? 'text-red-500' : 'text-gray-800'}`}>NT$ {Math.floor(budgetStatus.remaining).toLocaleString()}</div>
                                <div className="text-xs text-gray-400 font-bold mt-1">Á∏ΩÈ†êÁÆó: {totalBudget.toLocaleString()}</div>
                            </div>
                        </div>
                        <button onClick={()=>setShowSettingsModal(true)} className="p-3 bg-gray-100 rounded-full text-gray-500 hover:text-blue-500 hover:bg-blue-50 transition-colors"><Edit2 size={20}/></button>
                    </div>
                );
            };

            return (
                <div className={`h-full w-full font-sans bg-gray-50 flex flex-col text-gray-800 transition-colors duration-500 ${activeTab === 'accounting' ? 'bg-blue-50/30' : activeTab === 'shopping' ? 'bg-yellow-50/30' : 'bg-pink-50/30'}`}>
                    
                    {/* --- HEADER --- */}
                    <div className="flex-none bg-white/95 backdrop-blur-md shadow-md z-30 pt-safe-top rounded-b-3xl">
                        <div className="max-w-md mx-auto px-4 py-4">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-2xl font-black flex items-center tracking-tight">
                                    {activeTab === 'accounting' ? <><Camera className="mr-2 text-blue-500" size={28}/>Â∞èÂÖ´Ë≤ìË®òÂ∏≥</> : activeTab === 'shopping' ? <><ShoppingBag className="mr-2 text-yellow-500" size={28}/>ÁÉèËñ©Â•áË≥ºÁâ©</> : <><Heart className="mr-2 text-pink-500" size={28}/>Âêâ‰ºäÊâãÂ∏≥</>}
                                </h1>
                                <div className="flex space-x-2">
                                    <button onClick={() => setShowSettingsModal(true)} className="p-3 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-600"><Settings size={22}/></button>
                                    {activeTab === 'accounting' && (
                                        <>
                                            <button onClick={() => setShowCalculatorModal(true)} className="p-3 bg-indigo-100 text-indigo-600 rounded-full"><Calculator size={22}/></button>
                                            <button onClick={() => setShowSettlementModal(true)} className="p-3 bg-pink-100 text-pink-600 rounded-full"><Users size={22}/></button>
                                        </>
                                    )}
                                    {activeTab === 'shopping' && <button onClick={() => setShowImportModal(true)} className="px-4 py-2 bg-yellow-400 text-white rounded-full text-base font-black shadow-sm flex items-center"><Wand2 size={18} className="mr-1"/>ÂåØÂÖ•</button>}
                                </div>
                            </div>
                            <div className="flex bg-gray-100/50 p-1 rounded-2xl">
                                <TabButton id="accounting" label="Ë®òÂ∏≥" icon={Wallet} activeTab={activeTab} setActiveTab={setActiveTab} mainColor="text-blue-500 border-blue-200" />
                                <TabButton id="shopping" label="Ë≥ºÁâ©" icon={ShoppingBag} activeTab={activeTab} setActiveTab={setActiveTab} mainColor="text-yellow-500 border-yellow-200" />
                                <TabButton id="schedule" label="ÊâãÂ∏≥" icon={Heart} activeTab={activeTab} setActiveTab={setActiveTab} mainColor="text-pink-500 border-pink-200" />
                            </div>
                        </div>
                    </div>

                    {/* --- MAIN CONTENT SCROLL AREA --- */}
                    <main className="flex-1 overflow-y-auto pb-safe-bottom overscroll-contain">
                        <div className="max-w-md mx-auto px-4 py-6 space-y-8 pb-20">
                            
                            {/* ACCOUNTING TAB */}
                            {activeTab === 'accounting' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                    <BudgetRing />
                                    <div className="flex space-x-4 overflow-x-auto pb-2 snap-x hide-scrollbar">
                                        {currencies.map(c => {
                                            const data = stats[c.code] || { bal: 0 };
                                            if (data.bal === 0 && c.code !== 'TWD') return null;
                                            return (
                                                <div key={c.code} className="snap-center shrink-0 w-48 bg-white rounded-2xl shadow-sm border-2 border-blue-100 p-4 relative overflow-hidden">
                                                    <div className="flex justify-between items-center mb-2"><span className="text-sm font-black text-blue-500 bg-blue-50 px-2 py-1 rounded-lg">{c.code}</span><span className="text-2xl">{c.flag}</span></div>
                                                    <div className="text-2xl font-black text-gray-800">{c.symbol} {data.bal.toLocaleString()}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="bg-white rounded-3xl shadow-lg p-5 border-2 border-white">
                                        <form onSubmit={handleAddTransaction} className="space-y-5">
                                            <div className="flex gap-3">
                                                <div className="flex bg-blue-50 p-1.5 rounded-2xl flex-1">{['expense','income'].map(t => <button key={t} type="button" onClick={()=>setType(t)} className={`flex-1 py-3 rounded-xl text-base font-black transition-all ${type===t?'bg-white text-blue-600 shadow-md':'text-gray-400'}`}>{t==='expense'?'ÊîØÂá∫':'Êî∂ÂÖ•'}</button>)}</div>
                                                <div className="flex bg-pink-50 p-1.5 rounded-2xl flex-1">
                                                    <button type="button" onClick={()=>setUsageType('self')} className={`flex-1 py-3 rounded-xl text-base font-black transition-all ${usageType==='self'?'bg-white text-pink-600 shadow-md':'text-gray-400'}`}>Ëá™Áî®</button>
                                                    <button type="button" onClick={()=>setUsageType('help_buy')} className={`flex-1 py-3 rounded-xl text-base font-black transition-all ${usageType==='help_buy'?'bg-white text-pink-600 shadow-md':'text-gray-400'}`}>‰ª£Ë≥º</button>
                                                </div>
                                            </div>
                                            {usageType === 'help_buy' && <input type="text" value={targetName} onChange={e=>setTargetName(e.target.value)} placeholder="Âπ´Ë™∞Ë≤∑Ôºü" className="w-full bg-pink-50 border-2 border-pink-100 rounded-2xl p-4 text-lg font-bold focus:border-pink-400 outline-none" required />}
                                            <div className="flex gap-3">
                                                <div className="relative flex-1"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xl">{getCurrencySymbol(currency)}</span><input type="number" inputMode="decimal" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="w-full pl-12 p-4 bg-gray-50 rounded-2xl text-3xl font-black focus:bg-white focus:ring-4 focus:ring-blue-100 outline-none transition-all h-20" required step="0.01" /></div>
                                                <select value={currency} onChange={e=>setCurrency(e.target.value)} className="bg-gray-100 border-none rounded-2xl px-3 text-lg font-black w-24 text-center">{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select>
                                            </div>
                                            <div className="flex gap-3">
                                                <select value={paymentMethod} onChange={e=>setPaymentMethod(e.target.value)} className="bg-gray-50 border-none rounded-2xl p-4 text-lg font-bold flex-1 h-16">{paymentMethods.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select>
                                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="bg-gray-50 border-none rounded-2xl px-3 text-base font-bold w-40 h-16 text-center" />
                                            </div>
                                            <div className="flex gap-3">
                                                <input type="text" value={description} onChange={e=>setDescription(e.target.value)} placeholder="ÂìÅÈ†ÖÂÇôË®ª..." className="bg-gray-50 border-none rounded-2xl p-4 text-xl font-bold flex-1 h-16" required />
                                                <button type="submit" className="bg-blue-500 hover:bg-blue-600 text-white rounded-2xl px-6 shadow-xl shadow-blue-200 active:scale-95 transition-all flex items-center justify-center"><Camera size={28} strokeWidth={3} /></button>
                                            </div>
                                        </form>
                                    </div>
                                    <div className="space-y-4">
                                        {transactions.map(t => (
                                            <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between">
                                                <div className="flex items-center space-x-4">
                                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${t.type==='income'?'bg-green-100 text-green-600':'bg-red-50 text-red-500'}`}>{t.type==='income' ? '+' : '-'}</div>
                                                    <div>
                                                        <div className="flex items-center space-x-2"><span className="font-bold text-gray-800 text-lg">{t.description}</span>{t.usageType==='help_buy' && <span className="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded font-bold">{t.targetName}</span>}</div>
                                                        <div className="text-sm text-gray-400 font-bold">{t.date} ‚Ä¢ {paymentMethods.find(p=>p.id===t.paymentMethod)?.name || t.paymentMethod}</div>
                                                    </div>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    <div className="text-right"><div className={`font-black text-xl ${t.type==='income'?'text-green-600':'text-gray-900'}`}>{getCurrencySymbol(t.currency)} {t.amount.toLocaleString()}</div><div className="text-sm text-gray-400 font-bold">{t.currency}</div></div>
                                                    <button onClick={()=>deleteDoc(doc(db,'artifacts',DB_PREFIX,'users',user.uid,'transactions',t.id))} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={24}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* SHOPPING TAB */}
                            {activeTab === 'shopping' && (
                                <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
                                    {shoppingList.length === 0 ? <div className="text-center py-20 text-gray-400"><ShoppingBag size={64} className="mx-auto mb-4 opacity-30"/><p className="text-xl font-bold">Ê∏ÖÂñÆÁ©∫Á©∫ÁöÑÔºåÂø´ÂåØÂÖ•ÂêßÔºÅ</p></div> : 
                                        shoppingList.map(item => (
                                            <div key={item.id} className={`p-5 rounded-2xl border-2 flex items-center justify-between ${item.isBought ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-yellow-100 shadow-sm'}`}>
                                                <div className="flex items-center space-x-4">
                                                    <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center ${item.isBought ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200 text-transparent'}`}><CheckCircle size={20} fill="currentColor" /></div>
                                                    <span className={`font-bold text-xl ${item.isBought?'line-through text-gray-400':'text-gray-800'}`}>{item.item}</span>
                                                </div>
                                                {!item.isBought ? <button onClick={()=>{setDescription(item.item); setActiveTab('accounting'); window.scrollTo({ top: 0, behavior: 'smooth' });}} className="bg-yellow-400 text-white px-5 py-3 rounded-2xl text-lg font-black shadow-md active:scale-95">Ë≤∑‰∫ÜÔºÅ</button> : <button onClick={()=>deleteDoc(doc(db,'artifacts',DB_PREFIX,'users',user.uid,'shopping_list',item.id))} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={24}/></button>}
                                            </div>
                                        ))
                                    }
                                </div>
                            )}

                            {/* SCHEDULE TAB */}
                            {activeTab === 'schedule' && (
                                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                    {/* Cover Photo */}
                                    <div className="relative w-full h-48 bg-gray-100 rounded-3xl overflow-hidden group shadow-inner border-4 border-white">
                                        {dailyPhotos[scheduleDay] ? ( <img src={dailyPhotos[scheduleDay]} alt="Cover" className="w-full h-full object-cover" /> ) : ( <div className="w-full h-full flex flex-col items-center justify-center text-gray-300"><ImageIcon size={48} className="mb-2"/><span className="text-base font-bold">ÈªûÊìäË®≠ÂÆöÊú¨Êó•Â∞ÅÈù¢</span></div> )}
                                        <div className="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer">
                                            <input type="file" ref={photoInputRef} accept="image/*" onChange={handleUploadCoverPhoto} className="hidden" id="cover-upload" />
                                            <label htmlFor="cover-upload" className="text-white font-black text-xl flex items-center cursor-pointer bg-black/30 px-4 py-2 rounded-full backdrop-blur-md"><Camera className="mr-2" size={24}/> Êõ¥ÊèõÂ∞ÅÈù¢</label>
                                        </div>
                                    </div>

                                    {/* Day Selector */}
                                    <div className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm">
                                        <button onClick={() => setDayViewStartIndex(Math.max(0, dayViewStartIndex - 1))} disabled={dayViewStartIndex===0} className="p-3 text-gray-400 disabled:opacity-20 hover:text-pink-500"><ChevronLeft size={28}/></button>
                                        <div className="flex gap-2 overflow-hidden flex-1 justify-center">
                                            {visibleDays.map(d => ( <button key={d} onClick={() => setScheduleDay(d)} className={`px-5 py-3 rounded-xl text-base font-bold transition-all ${scheduleDay === d ? 'bg-pink-500 text-white shadow-md scale-105' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`}>{d}</button> ))}
                                            <button onClick={handleAddDay} className="px-4 py-3 rounded-xl border-2 border-dashed border-pink-300 text-pink-300 hover:bg-pink-50" title="Êñ∞Â¢ûÂ§©Êï∏"><Plus size={20}/></button>
                                        </div>
                                        <button onClick={() => setDayViewStartIndex(Math.min(tripDays.length - 3, dayViewStartIndex + 1))} disabled={dayViewStartIndex >= tripDays.length - 3} className="p-3 text-gray-400 disabled:opacity-20 hover:text-pink-500"><ChevronRight size={28}/></button>
                                    </div>
                                    <div className="flex justify-end px-2">
                                        <button onClick={handleDeleteCurrentDay} className="text-red-400 text-sm font-bold flex items-center bg-red-50 px-3 py-1 rounded-lg"><Trash2 size={14} className="mr-1"/> Âà™Èô§ {scheduleDay}</button>
                                    </div>

                                    {/* Event Form */}
                                    <form onSubmit={handleScheduleSubmit} className={`p-5 rounded-3xl shadow-sm border-2 space-y-4 transition-colors ${editingEventId ? 'bg-pink-50 border-pink-200' : 'bg-white border-pink-100'}`}>
                                        <div className="flex items-center justify-between"><span className="text-sm font-bold text-pink-400">{editingEventId ? '‚úèÔ∏è ‰øÆÊîπË°åÁ®ã' : '‚ú® Êñ∞Â¢ûÂõûÊÜ∂'}</span>{editingEventId && <button type="button" onClick={() => { setEditingEventId(null); setNewEventTitle(''); setNewEventLocation(''); setNewEventTime(''); }} className="text-sm font-bold text-gray-400">ÂèñÊ∂à</button>}</div>
                                        <div className="flex space-x-3">
                                            <input type="time" value={newEventTime} onChange={e=>setNewEventTime(e.target.value)} className="bg-gray-50 rounded-2xl px-3 text-lg font-bold outline-none border-2 border-transparent focus:bg-white focus:border-pink-300 h-14" />
                                            <input type="text" value={newEventTitle} onChange={e=>setNewEventTitle(e.target.value)} placeholder="Ë¶ÅÂÅö‰ªÄÈ∫ºÂë¢Ôºü" className="flex-1 bg-gray-50 rounded-2xl px-4 py-3 text-lg font-bold outline-none border-2 border-transparent focus:bg-white focus:border-pink-300 h-14" required />
                                        </div>
                                        <div className="flex items-center space-x-3">
                                            <MapPin size={24} className="text-pink-300" />
                                            <input type="text" value={newEventLocation} onChange={e=>setNewEventLocation(e.target.value)} placeholder="Âú∞Èªû (ÂèØÈÅ∏)" className="flex-1 bg-transparent border-b-2 border-pink-100 text-lg py-2 outline-none focus:border-pink-400 text-gray-500 font-bold" />
                                            <button type="submit" className={`p-3 rounded-full shadow-lg text-white transition-transform active:scale-95 ${editingEventId ? 'bg-green-400' : 'bg-pink-400'}`}>{editingEventId ? <Save size={24} /> : <Plus size={28} />}</button>
                                        </div>
                                    </form>

                                    {/* Timeline */}
                                    <div className="relative pl-6 space-y-5">
                                        <div className="absolute left-9 top-0 bottom-0 w-1 bg-pink-200 rounded-full"></div>
                                        {schedule.filter(s => s.day === scheduleDay).length === 0 ? <div className="text-center py-16 pl-6 text-gray-400 text-lg font-bold">ÈÄôÂ§©ÈÇÑÊ≤íÊúâÂÆâÊéíË°åÁ®ãÂñî</div> : 
                                            schedule.filter(s => s.day === scheduleDay).map((event) => (
                                                <div key={event.id} className={`relative flex items-start space-x-5 group ${editingEventId === event.id ? 'opacity-50' : ''}`}>
                                                    <div className="absolute left-2 mt-2 w-5 h-5 bg-pink-400 rounded-full ring-4 ring-white z-10 shadow-sm"></div>
                                                    <div className="flex-1 bg-white p-5 rounded-3xl shadow-sm border-2 border-pink-50 relative hover:border-pink-200 transition-colors">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <span className="inline-block bg-pink-50 text-pink-600 text-sm px-3 py-1 rounded-full font-black tracking-wider">{event.time}</span>
                                                            <div className="flex space-x-3">
                                                                <button onClick={() => { setEditingEventId(event.id); setNewEventTime(event.time); setNewEventTitle(event.title); setNewEventLocation(event.location || ''); }} className="text-gray-300 hover:text-blue-400"><Edit2 size={20} /></button>
                                                                <button onClick={() => { if(window.confirm('Âà™Èô§Ôºü')) deleteDoc(doc(db, 'artifacts', DB_PREFIX, 'users', user.uid, 'schedule', event.id)) }} className="text-gray-300 hover:text-red-400"><Trash2 size={20} /></button>
                                                            </div>
                                                        </div>
                                                        <h3 className="font-black text-gray-800 text-xl">{event.title}</h3>
                                                        {event.location && (
                                                            <div className="flex items-center mt-3 space-x-3">
                                                                <div className="flex items-center text-sm font-bold text-gray-500"><MapPin size={16} className="mr-1" /> {event.location}</div>
                                                                <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}`} target="_blank" rel="noopener noreferrer" className="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full flex items-center hover:bg-green-100 font-bold border border-green-200"><MapIcon size={14} className="mr-1" /> Â∞éËà™</a>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* --- MODALS --- */}
                    {/* Settings Modal */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in" onClick={()=>setShowSettingsModal(false)}>
                            <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-black flex items-center"><Settings className="mr-3" size={28}/> Ë®≠ÂÆö‰∏≠ÂøÉ</h2><button onClick={()=>setShowSettingsModal(false)} className="bg-gray-100 p-3 rounded-full"><X size={24}/></button></div>
                                
                                {/* Backup & Restore */}
                                <div className="mb-8 p-5 bg-indigo-50 rounded-2xl border-2 border-indigo-100">
                                    <h3 className="text-xl font-bold text-indigo-800 mb-4 flex items-center"><FileJson size={24} className="mr-2"/> Ë≥áÊñôÂÇô‰ªΩËàáÈÇÑÂéü</h3>
                                    <p className="text-sm text-gray-500 mb-4 font-bold">Ë≥áÊñôÁõÆÂâçÂÉÖÂ≠òÂú®Ê≠§ÊâãÊ©ü‰∏≠ÔºåË´ãÂÆöÊúü‰∏ãËºâÂÇô‰ªΩ‰ª•ÂÖçÈÅ∫Â§±ÔºÅ</p>
                                    <div className="flex gap-3">
                                        <button onClick={handleExportData} className="flex-1 py-3 bg-white border-2 border-indigo-200 text-indigo-600 rounded-xl font-black shadow-sm flex items-center justify-center active:scale-95"><Download size={20} className="mr-2"/> ÂÇô‰ªΩË≥áÊñô</button>
                                        <label className="flex-1 py-3 bg-indigo-500 text-white rounded-xl font-black shadow-lg flex items-center justify-center active:scale-95 cursor-pointer">
                                            <Upload size={20} className="mr-2"/> ÈÇÑÂéüË≥áÊñô
                                            <input type="file" ref={dataImportInputRef} onChange={handleImportData} accept=".json" className="hidden" />
                                        </label>
                                    </div>
                                </div>

                                <div className="mb-8 p-5 bg-blue-50 rounded-2xl border-2 border-blue-100"><label className="text-lg font-bold text-blue-600 block mb-2">üí∞ Á∏ΩÈ†êÁÆó (Âè∞Âπ£)</label><input type="number" value={totalBudget} onChange={e=>{const v=parseInt(e.target.value);setTotalBudget(v);saveSettings({totalBudget:v})}} className="w-full bg-white rounded-xl p-3 font-bold text-2xl outline-none focus:ring-4 focus:ring-blue-200" /></div>
                                
                                <div className="mb-8">
                                    <h3 className="text-xl font-bold text-gray-700 mb-4">üí≥ ÊîØ‰ªòÂ∑•ÂÖ∑</h3>
                                    <div className="space-y-3 mb-4">
                                        {paymentMethods.map(p=><div key={p.id} className="flex justify-between bg-gray-50 p-4 rounded-xl border border-gray-100 items-center"><span className="font-bold text-lg">{p.name}</span><button onClick={()=>handleDeletePaymentMethod(p.id)} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={20}/></button></div>)}
                                    </div>
                                    <div className="flex gap-2 bg-blue-50 p-2 rounded-xl">
                                        <input value={newPaymentName} onChange={e=>setNewPaymentName(e.target.value)} placeholder="Êñ∞Â¢ûÊîØ‰ªòÂêçÁ®±..." className="flex-1 bg-white rounded-lg px-3 text-lg font-bold outline-none"/>
                                        <button onClick={handleAddPaymentMethod} className="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold">Êñ∞Â¢û</button>
                                    </div>
                                </div>

                                <div className="mb-8">
                                    <h3 className="text-xl font-bold text-gray-700 mb-4">üí± Âπ£Âà•ÂåØÁéá</h3>
                                    <div className="space-y-3 mb-4">
                                        {currencies.map(c=><div key={c.code} className="flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-100"><div className="flex items-center"><span className="mr-3 text-2xl">{c.flag}</span><span className="font-black text-lg">{c.code}</span><span className="text-sm text-gray-400 mx-3 font-bold">ÂåØÁéá:</span><input type="number" value={c.rate} onChange={e=>{const m=currencies.map(x=>x.code===c.code?{...x,rate:parseFloat(e.target.value)}:x);setCurrencies(m);saveSettings({currencies:m})}} className="w-20 bg-white rounded-lg px-2 py-1 text-base font-bold border"/></div><button onClick={()=>handleDeleteCurrency(c.code)} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={20}/></button></div>)}
                                    </div>
                                    <div className="flex gap-2 bg-green-50 p-2 rounded-xl">
                                        <input value={newCurrencyCode} onChange={e=>setNewCurrencyCode(e.target.value)} placeholder="‰ª£Á¢º (ex: KRW)" className="w-24 bg-white rounded-lg px-3 text-lg font-bold outline-none"/>
                                        <input value={newCurrencyRate} onChange={e=>setNewCurrencyRate(e.target.value)} placeholder="ÂåØÁéá" type="number" className="flex-1 bg-white rounded-lg px-3 text-lg font-bold outline-none"/>
                                        <button onClick={handleAddCurrency} className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold">Êñ∞Â¢û</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Calculator Modal */}
                    {showCalculatorModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm animate-in fade-in" onClick={()=>setShowCalculatorModal(false)}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-2xl font-black mb-6 flex items-center"><Calculator className="mr-3 text-indigo-500" size={32}/> ÂåØÁéáË©¶ÁÆó</h3>
                                <div className="space-y-6">
                                    <div><label className="text-sm text-gray-500 font-bold block mb-2">ÂåØÁéá</label><input type="number" value={calcRate} onChange={e=>setCalcRate(e.target.value)} className="w-full bg-indigo-50 rounded-2xl p-4 text-2xl font-black text-indigo-900 outline-none"/></div>
                                    <div><label className="text-sm text-gray-500 font-bold block mb-2">Â§ñÂπ£ÈáëÈ°ç</label><input type="number" value={calcAmount} onChange={e=>setCalcAmount(e.target.value)} className="w-full bg-gray-50 rounded-2xl p-4 text-2xl font-black outline-none"/></div>
                                    <div className="bg-gray-100 rounded-2xl p-6 text-center"><div className="text-sm text-gray-500 font-bold mb-1">Á¥ÑÂêàÂè∞Âπ£</div><div className="text-4xl font-black text-gray-800">NT$ {Math.round(calcAmount*calcRate).toLocaleString()}</div></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settlement Modal */}
                    {showSettlementModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={()=>setShowSettlementModal(false)}><div className="bg-white w-full max-w-md rounded-3xl p-8 h-[80vh] flex flex-col" onClick={e=>e.stopPropagation()}><h3 className="font-black text-2xl mb-6">‰ª£Ë≥ºÁµêÁÆó</h3><div className="flex-1 overflow-y-auto">{Object.keys(settlement).length===0?<p className="text-gray-400 text-center text-xl mt-10">ÁÑ°Ë≥áÊñô</p>:Object.entries(settlement).map(([n,c])=><div key={n} className="mb-6 border-b-2 pb-4"><div className="font-black text-xl mb-2 flex items-center"><span className="w-3 h-3 bg-blue-500 rounded-full mr-3"></span>{n}</div>{Object.entries(c).map(([curr,v])=><div key={curr} className="flex justify-between text-lg mb-1"><span className="text-gray-500 font-bold">{curr}</span><span className="font-black text-blue-600">{getCurrencySymbol(curr)}{v.toLocaleString()}</span></div>)}</div>)}</div></div></div>}

                    {/* Import Modals */}
                    {showImportModal && <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={()=>setShowImportModal(false)}><div className="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl" onClick={e=>e.stopPropagation()}><h3 className="text-2xl font-black text-yellow-600 mb-4">È≠îÊ≥ïÂåØÂÖ•</h3><textarea value={importText} onChange={e=>setImportText(e.target.value)} className="w-full h-48 bg-yellow-50 rounded-2xl p-4 text-lg mb-6 border-none font-medium"/><button onClick={async()=>{const l=importText.split(/\r?\n/).filter(x=>x.trim());const appId='local-app';await Promise.all(l.map(i=>addDoc(collection(db,'artifacts',DB_PREFIX,'users',user.uid,'shopping_list'),{item:i,isBought:false,createdAt:serverTimestamp()})));setShowImportModal(false)}} className="w-full py-4 bg-yellow-400 text-white rounded-2xl text-xl font-black shadow-lg">ËÆäËÆäËÆäÔºÅ</button></div></div>}

                    {showScheduleImportModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={()=>setShowScheduleImportModal(false)}>
                            <div className="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-2xl font-black mb-6 text-pink-500">ÂåØÂÖ•ÂõûÊÜ∂</h3>
                                <select value={scheduleImportTargetDay} onChange={e=>setScheduleImportTargetDay(e.target.value)} className="w-full bg-pink-50 rounded-2xl p-4 mb-6 text-xl font-bold text-pink-600 border-none">{tripDays.map(d=><option key={d} value={d}>{d}</option>)}</select>
                                <div className="mb-6 border-4 border-dashed border-pink-200 rounded-3xl p-8 text-center bg-pink-50/50">
                                    <input type="file" ref={fileInputRef} accept="image/*" onChange={handleImageUpload} className="hidden" id="img-upload"/>
                                    <label htmlFor="img-upload" className="flex flex-col items-center justify-center cursor-pointer text-pink-400">{isAnalyzingImage ? <Loader2 className="animate-spin" size={48}/> : <><ImageIcon size={48}/><span className="text-lg font-bold mt-2">‰∏äÂÇ≥ÂúñÁâáËæ®Ë≠ò</span></>}</label>
                                </div>
                                <textarea value={scheduleImportText} onChange={e=>setScheduleImportText(e.target.value)} className="w-full h-32 bg-gray-50 rounded-2xl p-4 mb-6 text-lg" placeholder="ÊàñË≤º‰∏äÊñáÂ≠ó..."/>
                                <button onClick={async()=>{
                                    const lines = scheduleImportText.split(/\r?\n/);
                                    const appId = 'local-app';
                                    await Promise.all(lines.map(line => {
                                        const m = line.trim().match(/(\d{1,2}[:Ôºö]\d{2})/);
                                        if(m) addDoc(collection(db,'artifacts',DB_PREFIX,'users',user.uid,'schedule'),{day:scheduleImportTargetDay,time:m[1].replace('Ôºö',':').padStart(5,'0'),title:line.replace(m[0],'').trim().replace(/^[:Ôºö\-\s]+/,''),location:'',createdAt:serverTimestamp()});
                                    }));
                                    setShowScheduleImportModal(false);
                                }} className="w-full py-4 bg-pink-400 text-white rounded-2xl text-xl font-black shadow-lg">ÊñáÂ≠óÂåØÂÖ•</button>
                            </div>
                        </div>
                    )}

                    {/* Generic Confirmation Modal */}
                    {confirmModal.show && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setConfirmModal({ ...confirmModal, show: false })}>
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="text-center mb-4">
                                    <div className="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2"><AlertTriangle className="text-red-500" size={24} /></div>
                                    <h3 className="text-xl font-black text-gray-800">{confirmModal.title}</h3>
                                    <p className="text-gray-500 mt-2">{confirmModal.message}</p>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setConfirmModal({ ...confirmModal, show: false })} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ÂèñÊ∂à</button>
                                    <button onClick={confirmModal.onConfirm} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg">Á¢∫ÂÆöÂà™Èô§</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showInstallGuide && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-md" onClick={()=>setShowInstallGuide(false)}>
                            <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl relative" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-2xl font-black text-gray-800 mb-6 flex items-center"><Smartphone className="mr-3" size={28}/> Âä†ÂÖ•‰∏ªÁï´Èù¢</h3>
                                <div className="space-y-6 text-lg text-gray-600">
                                    <div className="flex items-start">
                                        <span className="bg-gray-100 px-3 py-1 rounded-lg mr-3 font-bold text-base">iOS</span>
                                        <p>ÈªûÊìä‰∏ãÊñπ„ÄåÂàÜ‰∫´„Äç<Share size={16} className="inline"/>ÔºåÂæÄ‰∏ãÊªëÈªûÊìä„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„Äç„ÄÇ</p>
                                    </div>
                                    <div className="flex items-start">
                                        <span className="bg-gray-100 px-3 py-1 rounded-lg mr-3 font-bold text-base">Android</span>
                                        <p>ÈªûÊìäÈÅ∏ÂñÆÔºåÈÅ∏Êìá„ÄåÂä†Âà∞‰∏ªÁï´Èù¢„ÄçÊàñ„ÄåÂÆâË£ù„Äç„ÄÇ</p>
                                    </div>
                                </div>
                                <button onClick={()=>setShowInstallGuide(false)} className="w-full mt-8 py-4 bg-gray-800 text-white font-black text-xl rounded-2xl">Áü•ÈÅì‰∫Ü</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
