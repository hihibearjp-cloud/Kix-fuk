import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  updateDoc,
  setDoc,
  doc, 
  onSnapshot, 
  serverTimestamp,
  query,
  orderBy,
  writeBatch
} from 'firebase/firestore';
import { 
  Plus, Trash2, Wallet, CreditCard, Download, Smartphone, Train, 
  ShoppingBag, Users, X, CheckCircle, Calendar, MapPin, Heart, 
  FileText, Edit2, Save, RotateCcw, Sparkles, Camera, Wand2, 
  Settings, Calculator, ChevronLeft, ChevronRight, Map, Gift, 
  Star, Table, Building, Receipt, Tag, StickyNote, Split, 
  AlertTriangle, RefreshCw, BookHeart, PenTool, Image as ImageIcon, Loader2,
  Coins, Database
} from 'lucide-react';

// --- 1. Firebase Config ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- 2. Gemini API Key ---
const apiKey = ""; 

// --- 3. Defaults ---
const DEFAULT_CURRENCIES = [
  { code: 'TWD', label: 'Âè∞Âπ£', symbol: 'NT$', rate: 1 },
  { code: 'JPY', label: 'Êó•Âπ£', symbol: '¬•', rate: 0.215 },
  { code: 'USD', label: 'ÁæéÂÖÉ', symbol: '$', rate: 32.5 },
];
const DEFAULT_PAYMENT_METHODS = [
  { id: 'cash', name: 'ÁèæÈáë' }, 
  { id: 'card', name: 'Âà∑Âç°' }, 
  { id: 'suica', name: 'Ë•øÁìúÂç°' }
];
const DEFAULT_DAYS = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'];
const DEFAULT_CATEGORIES = ['È£≤È£ü', '‰∫§ÈÄö', '‰ΩèÂÆø', 'Ë≥ºÁâ©', 'ÈñÄÁ•®', 'ÂÖ∂‰ªñ'];
const DEFAULT_PLATFORMS = ['ÁèæÂ†¥/‰∏ÄËà¨', 'Jalan', 'Agoda', 'Klook', 'KKday'];

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('schedule'); // Default Left
  const [isLoading, setIsLoading] = useState(true);
  
  // Settings
  const [currencies, setCurrencies] = useState(DEFAULT_CURRENCIES);
  const [tripDays, setTripDays] = useState(DEFAULT_DAYS);
  const [totalBudget, setTotalBudget] = useState(50000);
  const [paymentMethods, setPaymentMethods] = useState(DEFAULT_PAYMENT_METHODS);
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
  const [platforms, setPlatforms] = useState(DEFAULT_PLATFORMS);

  // Data
  const [transactions, setTransactions] = useState([]);
  const [shoppingList, setShoppingList] = useState([]);
  const [schedule, setSchedule] = useState([]);
  const [diaryEntries, setDiaryEntries] = useState([]);
  const [dailyPhotos, setDailyPhotos] = useState({});

  // Inputs
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [note, setNote] = useState('');
  const [type, setType] = useState('expense');
  const [currency, setCurrency] = useState('JPY'); 
  const [paymentMethod, setPaymentMethod] = useState('cash');
  const [category, setCategory] = useState('È£≤È£ü'); 
  const [platform, setPlatform] = useState('ÁèæÂ†¥/‰∏ÄËà¨');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [targetName, setTargetName] = useState('');
  const [usageType, setUsageType] = useState('self');
  
  // Schedule Inputs
  const [scheduleDay, setScheduleDay] = useState('Day 1');
  const [dayViewStartIndex, setDayViewStartIndex] = useState(0);
  const [newEventTitle, setNewEventTitle] = useState('');
  const [newEventTime, setNewEventTime] = useState('');
  const [newEventLocation, setNewEventLocation] = useState('');
  const [newEventCost, setNewEventCost] = useState('');
  const [editingEventId, setEditingEventId] = useState(null);
  
  // Diary Inputs
  const [diaryText, setDiaryText] = useState('');
  const [isGeneratingDiary, setIsGeneratingDiary] = useState(false);

  // Modals & Tools
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  const [showImportModal, setShowImportModal] = useState(false); // For Shopping
  const [showScheduleImportModal, setShowScheduleImportModal] = useState(false); // For Schedule
  const [showCalculatorModal, setShowCalculatorModal] = useState(false);
  const [importText, setImportText] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  
  // Calculator
  const [calcAmount, setCalcAmount] = useState('');
  const [calcRate, setCalcRate] = useState('0.215');
  const [calcResult, setCalcResult] = useState(0);

  // Refs
  const fileInputRef = useRef(null);
  const photoInputRef = useRef(null);
  const receiptInputRef = useRef(null);

  // --- Init ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    initAuth();
    return onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setIsLoading(false); });
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubTrx = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), orderBy('createdAt', 'desc')), snap => setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubShop = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'shopping_list'), snap => setShoppingList(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>(a.isBought===b.isBought?0:a.isBought?1:-1))));
    const unsubSch = onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), orderBy('time')), snap => setSchedule(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubDiary = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'diary'), snap => setDiaryEntries(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubPhotos = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'daily_photos'), snap => {
      const p = {}; snap.docs.forEach(d => p[d.id] = d.data().image); setDailyPhotos(p);
    });
    
    // Load Settings
    const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
    const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
      setIsLoading(false);
      if (docSnap.exists()) {
        const d = docSnap.data();
        if (d.tripDays) setTripDays(d.tripDays);
        if (d.totalBudget) setTotalBudget(d.totalBudget);
        if (d.currencies) setCurrencies(d.currencies);
        if (d.paymentMethods) setPaymentMethods(d.paymentMethods);
        if (d.categories) setCategories(d.categories);
        if (d.platforms) setPlatforms(d.platforms);
      } else {
        setDoc(settingsRef, { 
          tripDays: DEFAULT_DAYS, totalBudget: 50000, currencies: DEFAULT_CURRENCIES, 
          paymentMethods: DEFAULT_PAYMENT_METHODS, categories: DEFAULT_CATEGORIES, platforms: DEFAULT_PLATFORMS
        }, { merge: true });
      }
    });
    return () => { unsubTrx(); unsubShop(); unsubSch(); unsubDiary(); unsubPhotos(); unsubSettings(); };
  }, [user]);

  // --- Helpers ---
  const fileToBase64 = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
  const getCurrencySymbol = (code) => currencies.find(c => c.code === code)?.symbol || '$';

  // --- Logic ---
  const saveSettings = async (newConfig) => {
    if (!user) return;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), newConfig, { merge: true });
  };

  const handleAddTransaction = async (e) => {
    e.preventDefault();
    if (!amount || !description) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), {
      amount: parseFloat(amount), description, note, type, currency, paymentMethod, category, platform, date, usageType, targetName, createdAt: serverTimestamp()
    });
    setAmount(''); setDescription(''); setNote(''); alert("OK! Ë®òÂ•Ω‰∫Ü! ü•ú");
  };

  const handleScheduleSubmit = async (e) => {
    e.preventDefault();
    if (!newEventTitle) return;
    const data = { day: scheduleDay, time: newEventTime||'00:00', title: newEventTitle, location: newEventLocation, cost: newEventCost?parseFloat(newEventCost):0, createdAt: serverTimestamp() };
    if(editingEventId) {
       await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'schedule', editingEventId), { ...data, createdAt: undefined });
       setEditingEventId(null);
    } else {
       await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), data);
    }
    setNewEventTitle(''); setNewEventLocation(''); setNewEventTime(''); setNewEventCost('');
  };

  const handleSaveDiary = async () => {
    const existing = diaryEntries.find(d => d.day === scheduleDay);
    if (existing) {
       await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'diary', existing.id), { content: diaryText });
    } else {
       await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'diary'), { day: scheduleDay, content: diaryText, createdAt: serverTimestamp() });
    }
    alert("Êó•Ë®ò‰øùÂ≠òÊàêÂäüÔºÅüìî");
  };

  // AI Generation for Diary
  const handleAiDiary = async () => {
    setIsGeneratingDiary(true);
    try {
      const dayEvents = schedule.filter(s => s.day === scheduleDay).map(s => `${s.time} ${s.title}`).join(", ");
      const daySpent = transactions.filter(t => t.date === date).reduce((acc, t) => acc + t.amount, 0); 
      const prompt = `Act as Anya Forger from Spy x Family. Write a short, cute diary entry in Traditional Chinese for "Day: ${scheduleDay}". 
      Activities: ${dayEvents}. Total Spent approx: ${daySpent}. Use emojis and "Waku Waku" or "Peanuts". Keep it under 100 words.`;
      
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      const result = await response.json();
      setDiaryText(result.candidates?.[0]?.content?.parts?.[0]?.text || "AI Áù°Ëëó‰∫Ü...");
    } catch(e) { alert("AI ÈÄ£Á∑öÂ§±Êïó > <"); }
    finally { setIsGeneratingDiary(false); }
  };

  // AI Receipt
  const handleReceiptUpload = async (e) => {
    const file = e.target.files[0]; if (!file) return;
    setIsAnalyzing(true);
    try {
      const base64 = await fileToBase64(file);
      const prompt = `Analyze receipt. Return JSON: {"item": "string (Traditional Chinese)", "amount": number}. Estimate if needed.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64 } }] }] }) });
      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json/g, '').replace(/```/g, '').trim();
      const data = JSON.parse(text);
      if (data.item) setDescription(data.item); if (data.amount) setAmount(data.amount.toString());
      setActiveTab('accounting'); alert("Ëæ®Ë≠òÊàêÂäüÔºÅË´ãÁ¢∫Ë™çË≥áÊñô ‚ú®");
    } catch (e) { alert("Ëæ®Ë≠òÂ§±Êïó...Ë´ãÊâãÂãïËº∏ÂÖ•"); } finally { setIsAnalyzing(false); }
  };

  // Demo Data
  const loadDemo = async () => {
    if(!window.confirm("ÂåØÂÖ•ÁØÑ‰æãË≥áÊñôÔºü(ÊúÉÊñ∞Â¢û5Â§©Êù±‰∫¨Ë°åÁ®ã)")) return;
    try {
      const today = new Date().toISOString().split('T')[0];
      const s = [
        { day: 'Day 1', time: '10:00', title: 'ÊäµÈÅîÊù±‰∫¨ ‚úàÔ∏è', cost: 2000 },
        { day: 'Day 2', time: '09:00', title: 'Ëø™Â£´Â∞ºÊ®ÇÂúí üè∞', cost: 9800 },
        { day: 'Day 3', time: '11:00', title: 'ÊæÄË∞∑ SKY üèôÔ∏è', cost: 2500 }
      ];
      const t = [
        { amount: 1200, description: 'ÊãâÈ∫µ', type: 'expense', currency: 'JPY', category: 'È£≤È£ü', date: today },
        { amount: 15800, description: 'Ê©üÁ•®', type: 'expense', currency: 'TWD', category: '‰∫§ÈÄö', date: today }
      ];
      await Promise.all([
         ...s.map(d => addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'schedule'), { ...d, createdAt: serverTimestamp() })),
         ...t.map(d => addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), { ...d, createdAt: serverTimestamp() })),
         addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'shopping_list'), { item: 'Âêâ‰ºäÂç°ÂìáÂ®ÉÂ®É', isBought: false, createdAt: serverTimestamp() })
      ]);
      alert("ÂåØÂÖ•ÂÆåÊàêÔºÅWaku Waku!"); setShowSettingsModal(false); setActiveTab('schedule');
    } catch(e) { console.error(e); }
  };

  const handleCalc = () => { const a = parseFloat(calcAmount); const r = parseFloat(calcRate); if(!isNaN(a)&&!isNaN(r)) setCalcResult(Math.round(a*r*100)/100); };
  const handleUploadCover = async (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=async()=>{await setDoc(doc(db,'artifacts',appId,'users',user.uid,'daily_photos',scheduleDay),{image:r.result});}; r.readAsDataURL(f); };

  // Computed
  const budgetStatus = useMemo(() => {
    let totalTWD = 0;
    transactions.forEach(t => { 
      const rate = currencies.find(c => c.code === t.currency)?.rate || 1;
      if (t.type === 'expense') totalTWD += t.amount * rate;
    });
    const pct = Math.min(100, Math.max(0, (totalTWD / totalBudget) * 100));
    return { totalTWD, pct, remaining: totalBudget - totalTWD };
  }, [transactions, totalBudget, currencies]);

  const visibleDays = useMemo(() => {
    const maxStart = Math.max(0, tripDays.length - 3);
    const safeStart = Math.min(dayViewStartIndex, maxStart);
    return tripDays.slice(safeStart, safeStart + 3);
  }, [tripDays, dayViewStartIndex]);

  // Current Diary Content
  useEffect(() => {
    const entry = diaryEntries.find(d => d.day === scheduleDay);
    setDiaryText(entry ? entry.content : "");
  }, [scheduleDay, diaryEntries]);

  // --- 3D Components ---
  const NavButton = ({ id, label, icon: Icon, color }) => (
    <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all w-full ${activeTab === id ? `${color} text-white shadow-[4px_4px_0_#000] border-2 border-black transform -translate-y-1` : 'text-gray-400 hover:bg-gray-100 border-2 border-transparent'}`}>
      <Icon size={24} strokeWidth={3} className="mb-1 drop-shadow-sm"/>
      <span className="text-xs font-black">{label}</span>
    </button>
  );

  const Card3D = ({ children, className }) => (
    <div className={`bg-white border-4 border-black rounded-[2rem] shadow-[6px_6px_0_rgba(0,0,0,0.15)] p-5 ${className||''}`}>{children}</div>
  );

  if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-yellow-50"><Loader2 className="animate-spin text-4xl text-pink-400"/></div>;

  return (
    <div className="h-[100dvh] w-full font-sans bg-[#FFF8E7] flex flex-col text-gray-800" style={{ fontFamily: '"Comic Sans MS", "Chalkboard SE", sans-serif' }}>
      
      {/* HEADER */}
      <div className="flex-none bg-[#FFD1DC] border-b-4 border-black px-4 py-3 z-30 pt-safe-top">
         <div className="flex justify-between items-center max-w-md mx-auto">
            <h1 className="text-xl font-black flex items-center text-black drop-shadow-sm">
               <span className="bg-white border-2 border-black rounded-full p-1 mr-2"><Gift size={16} className="text-pink-500"/></span>
               ÂÆâÂ¶Æ‰∫ûÊóÖ‰∫∫ÊâãÂ∏≥
            </h1>
            <button onClick={() => setShowSettingsModal(true)} className="bg-white border-2 border-black rounded-xl p-2 shadow-[2px_2px_0_#000] active:shadow-none active:translate-y-1 transition-all"><Settings size={20}/></button>
         </div>
      </div>

      {/* NAVIGATION BAR (Top) */}
      <div className="flex-none bg-white border-b-4 border-black px-2 py-3 z-20">
         <div className="max-w-md mx-auto grid grid-cols-4 gap-2">
            <NavButton id="schedule" label="Ë°åÁ®ã" icon={Map} color="bg-[#88CCEE]" />
            <NavButton id="shopping" label="Ë≥ºÁâ©" icon={ShoppingBag} color="bg-[#FFCC00]" />
            <NavButton id="accounting" label="Ë®òÂ∏≥" icon={Wallet} color="bg-[#FF99CC]" />
            <NavButton id="diary" label="Êó•Ë®ò" icon={BookHeart} color="bg-[#B19CD9]" />
         </div>
      </div>

      {/* MAIN CONTENT */}
      <main className="flex-1 overflow-y-auto p-4 pb-20 overscroll-contain">
        <div className="max-w-md mx-auto space-y-6">

          {/* === TAB 1: SCHEDULE (Left) === */}
          {activeTab === 'schedule' && (
            <div className="space-y-6 animate-in slide-in-from-left duration-300">
               {/* Day Selector */}
               <Card3D className="bg-[#E0F7FA]">
                  <div className="flex justify-between items-center mb-4">
                     <button onClick={() => setDayViewStartIndex(Math.max(0, dayViewStartIndex - 1))} className="p-2 bg-white border-2 border-black rounded-lg shadow-[2px_2px_0_#000]"><ChevronLeft strokeWidth={3}/></button>
                     <h2 className="text-xl font-black text-[#006064]">{scheduleDay}</h2>
                     <button onClick={() => setDayViewStartIndex(Math.min(tripDays.length - 3, dayViewStartIndex + 1))} className="p-2 bg-white border-2 border-black rounded-lg shadow-[2px_2px_0_#000]"><ChevronRight strokeWidth={3}/></button>
                  </div>
                  <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar justify-center">
                     {visibleDays.map(d => (
                        <button key={d} onClick={() => setScheduleDay(d)} className={`px-3 py-2 rounded-xl font-black border-2 border-black transition-all whitespace-nowrap ${scheduleDay===d ? 'bg-[#00BCD4] text-white shadow-[4px_4px_0_#000] transform -translate-y-1' : 'bg-white text-gray-500'}`}>{d}</button>
                     ))}
                     <button onClick={()=>{const n=[...tripDays,`Day ${tripDays.length+1}`];setTripDays(n);saveSettings({tripDays:n})}} className="px-3 py-2 bg-white border-2 border-dashed border-gray-400 rounded-xl text-gray-400"><Plus/></button>
                  </div>
               </Card3D>
               
               {/* Daily Budget Info */}
               <div className="bg-white border-2 border-black rounded-xl p-3 text-center shadow-[4px_4px_0_#ccc]">
                  <span className="font-black text-gray-500">Êú¨Êó•È†ê‰º∞ÈñãÈä∑Ôºö</span>
                  <span className="font-black text-2xl text-[#00BCD4] ml-2">¬• {schedule.filter(s => s.day === scheduleDay).reduce((acc, curr) => acc + (curr.cost || 0), 0).toLocaleString()}</span>
               </div>

               {/* Add Event Form */}
               <Card3D className="bg-white">
                  <div className="flex gap-2 mb-3">
                     <input type="time" value={newEventTime} onChange={e=>setNewEventTime(e.target.value)} className="w-28 bg-gray-100 border-2 border-black rounded-xl p-2 font-bold" />
                     <input type="text" value={newEventTitle} onChange={e=>setNewEventTitle(e.target.value)} placeholder="ÂéªÂì™Ë£°Áé©Ôºü" className="flex-1 bg-gray-100 border-2 border-black rounded-xl p-2 font-bold" />
                  </div>
                  <div className="flex gap-2 mb-3">
                     <div className="flex-1 relative">
                        <MapPin size={18} className="absolute left-3 top-3 text-gray-400"/>
                        <input type="text" value={newEventLocation} onChange={e=>setNewEventLocation(e.target.value)} placeholder="Âú∞Èªû" className="w-full bg-gray-100 border-2 border-black rounded-xl pl-9 p-2 font-bold" />
                     </div>
                  </div>
                  <div className="flex gap-2">
                     <div className="flex-1 relative">
                        <span className="absolute left-3 top-3 text-gray-400 font-bold">¬•</span>
                        <input type="number" value={newEventCost} onChange={e=>setNewEventCost(e.target.value)} placeholder="È†ê‰º∞Ë≤ªÁî®" className="w-full bg-gray-100 border-2 border-black rounded-xl pl-8 p-2 font-bold" />
                     </div>
                     <button onClick={handleScheduleSubmit} className="bg-[#00BCD4] text-white p-3 rounded-xl border-2 border-black shadow-[3px_3px_0_#000] active:translate-y-1 active:shadow-none"><Plus strokeWidth={4}/></button>
                  </div>
               </Card3D>

               {/* Timeline */}
               <div className="space-y-4 relative pl-4 pb-20">
                  <div className="absolute left-8 top-0 bottom-0 w-2 bg-[#B2EBF2] rounded-full"></div>
                  {schedule.filter(s => s.day === scheduleDay).map(ev => (
                     <div key={ev.id} className="relative pl-10">
                        <div className="absolute left-0 top-6 w-6 h-6 bg-[#00BCD4] border-2 border-black rounded-full z-10"></div>
                        <Card3D className="p-4 relative">
                           <div className="flex justify-between items-start">
                              <div>
                                 <div className="bg-[#E0F7FA] text-[#006064] inline-block px-2 py-1 rounded-lg border-2 border-[#006064] text-xs font-black mb-1">{ev.time}</div>
                                 <div className="text-xl font-black mb-1">{ev.title}</div>
                                 {ev.location && <div className="text-sm text-gray-500 flex items-center font-bold mb-1"><MapPin size={14} className="mr-1"/>{ev.location}</div>}
                                 {ev.cost > 0 && <div className="text-sm text-[#FBC02D] font-black">¬• {ev.cost}</div>}
                              </div>
                              <div className="flex flex-col gap-2">
                                <button onClick={()=>deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'schedule',ev.id))} className="text-gray-300 hover:text-red-500"><Trash2 size={18}/></button>
                              </div>
                           </div>
                        </Card3D>
                     </div>
                  ))}
               </div>
            </div>
          )}

          {/* === TAB 2: SHOPPING (Middle Left) === */}
          {activeTab === 'shopping' && (
            <div className="space-y-6 animate-in fade-in duration-300">
               {/* Progress */}
               <Card3D className="bg-[#FFF9C4]">
                  <div className="flex justify-between items-center mb-2 font-black">
                     <span className="flex items-center text-yellow-700"><ShoppingBag className="mr-2"/> Ë≥ºÁâ©ÈÄ≤Â∫¶</span>
                     <span>{shoppingList.filter(i=>i.isBought).length}/{shoppingList.length}</span>
                  </div>
                  <div className="w-full bg-white border-2 border-black rounded-full h-4 overflow-hidden">
                     <div className="bg-[#FFEB3B] h-full transition-all border-r-2 border-black" style={{width: `${(shoppingList.filter(i=>i.isBought).length/shoppingList.length)*100}%`}}></div>
                  </div>
               </Card3D>

               {/* Add Item */}
               <div className="flex gap-2">
                  <button onClick={()=>setShowImportModal(true)} className="flex-1 bg-[#FBC02D] text-white py-3 rounded-2xl border-2 border-black shadow-[4px_4px_0_#000] font-black active:translate-y-1 active:shadow-none">ÊñáÂ≠ó/LINE ÂåØÂÖ•</button>
                  <button onClick={()=>alert("ÈñãÁôº‰∏≠...")} className="flex-1 bg-[#FF9800] text-white py-3 rounded-2xl border-2 border-black shadow-[4px_4px_0_#000] font-black active:translate-y-1 active:shadow-none flex items-center justify-center"><Camera className="mr-2" size={18}/> ÊãçÁÖß</button>
               </div>

               {/* List */}
               <div className="space-y-3 pb-20">
                  {shoppingList.map(item => (
                     <div key={item.id} className={`border-4 border-black rounded-2xl p-4 flex items-center justify-between shadow-[4px_4px_0_#ccc] transition-all ${item.isBought ? 'bg-gray-100 opacity-60' : 'bg-white'}`}>
                        <div className="flex items-center gap-3">
                           <div className={`w-8 h-8 rounded-lg border-2 border-black flex items-center justify-center ${item.isBought?'bg-green-400':'bg-white'}`}>{item.isBought && <CheckCircle size={20} color="white"/>}</div>
                           <span className="font-black text-lg">{item.item}</span>
                        </div>
                        {!item.isBought ? (
                           <button onClick={()=>{setDescription(item.item); setActiveTab('accounting');}} className="bg-[#FBC02D] text-white px-3 py-1 rounded-xl border-2 border-black shadow-[2px_2px_0_#000] active:translate-y-1 active:shadow-none font-bold text-sm">Ë≤∑‰∫Ü!</button>
                        ) : (
                           <button onClick={()=>deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'shopping_list',item.id))}><Trash2 className="text-gray-400"/></button>
                        )}
                     </div>
                  ))}
               </div>
            </div>
          )}

          {/* === TAB 3: ACCOUNTING (Middle Right) === */}
          {activeTab === 'accounting' && (
             <div className="space-y-6 animate-in fade-in duration-300">
                {/* Budget Ring */}
                <Card3D className="bg-[#F8BBD0] flex items-center justify-between">
                   <div className="relative w-24 h-24 flex items-center justify-center">
                      <svg className="w-full h-full -rotate-90"><circle cx="48" cy="48" r="40" stroke="white" strokeWidth="12" fill="none"/><circle cx="48" cy="48" r="40" stroke="#EC407A" strokeWidth="12" fill="none" strokeDasharray="251" strokeDashoffset={251 - (251 * (budgetStatus.pct/100))} strokeLinecap="round" /></svg>
                      <span className="absolute font-black text-white text-xl drop-shadow-md">{Math.round(budgetStatus.pct)}%</span>
                   </div>
                   <div className="flex-1 text-right">
                      <div className="text-xs font-black text-[#880E4F] mb-1">Ââ©È§òÈ†êÁÆó</div>
                      <div className="text-3xl font-black text-white drop-shadow-[2px_2px_0_#880E4F]">NT$ {(budgetStatus.remaining/1000).toFixed(1)}k</div>
                      <div className="text-xs font-bold text-[#AD1457] mt-1">Â∑≤Ëä±Ë≤ª: {Math.floor(budgetStatus.totalTWD).toLocaleString()}</div>
                   </div>
                </Card3D>

                {/* Input Form */}
                <Card3D className="bg-white">
                   <div className="space-y-3">
                      <div className="flex gap-2">
                         <div className="bg-gray-100 p-1 rounded-xl border-2 border-black flex flex-1">
                            {['expense','income'].map(t => <button key={t} onClick={()=>setType(t)} className={`flex-1 py-1 rounded-lg font-black transition-all ${type===t ? 'bg-[#EC407A] text-white border-2 border-black' : 'text-gray-400'}`}>{t==='expense'?'üí∏':'üí∞'}</button>)}
                         </div>
                         <div className="bg-gray-100 p-1 rounded-xl border-2 border-black flex flex-1">
                            {['self','group'].map(u => <button key={u} onClick={()=>setUsageType(u)} className={`flex-1 py-1 rounded-lg font-black transition-all ${usageType===u ? 'bg-[#EC407A] text-white border-2 border-black' : 'text-gray-400'}`}>{u==='self'?'Ëá™':'ÂÖ¨'}</button>)}
                         </div>
                      </div>
                      <div className="flex gap-2">
                         <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="ÈáëÈ°ç" className="flex-1 bg-gray-50 border-2 border-black rounded-xl p-3 text-2xl font-black outline-none" />
                         <select value={currency} onChange={e=>setCurrency(e.target.value)} className="bg-gray-50 border-2 border-black rounded-xl px-2 font-bold w-20">{currencies.map(c=><option key={c.code} value={c.code}>{c.code}</option>)}</select>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                         <select value={category} onChange={e=>setCategory(e.target.value)} className="bg-gray-50 border-2 border-black rounded-xl p-2 font-bold">{categories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                         <select value={paymentMethod} onChange={e=>setPaymentMethod(e.target.value)} className="bg-gray-50 border-2 border-black rounded-xl p-2 font-bold">{paymentMethods.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select>
                      </div>
                      <input type="text" value={description} onChange={e=>setDescription(e.target.value)} placeholder="Ë≤∑‰∫Ü‰ªÄÈ∫ºÔºü" className="w-full bg-gray-50 border-2 border-black rounded-xl p-3 font-bold" />
                      <button onClick={handleAddTransaction} className="w-full py-3 bg-[#EC407A] text-white rounded-2xl border-b-8 border-r-4 border-black/20 active:border-b-0 active:border-r-0 active:translate-y-2 active:translate-x-1 transition-all font-black text-lg shadow-xl flex items-center justify-center">ÂñÄÊì¶ÔºÅË®ò‰∏ã‰æÜ</button>
                   </div>
                </Card3D>

                {/* List */}
                <div className="space-y-3 pb-20">
                   {transactions.map(t => (
                      <div key={t.id} className="bg-white border-4 border-black rounded-2xl p-4 flex justify-between items-center shadow-[4px_4px_0_#eee]">
                         <div className="flex items-center gap-3">
                            <div className="text-2xl">{t.type==='expense'?'üí∏':'üí∞'}</div>
                            <div>
                               <div className="font-black text-lg">{t.description}</div>
                               <div className="text-xs font-bold text-gray-400 bg-gray-100 px-2 rounded inline-block">{t.category}</div>
                            </div>
                         </div>
                         <div className="text-right">
                            <div className="font-black text-xl">{currencies.find(c=>c.code===t.currency)?.symbol} {t.amount}</div>
                            <div className="text-xs font-bold text-gray-400">{t.paymentMethod}</div>
                         </div>
                      </div>
                   ))}
                </div>
             </div>
          )}

          {/* === TAB 4: DIARY (Rightmost) === */}
          {activeTab === 'diary' && (
            <div className="space-y-6 animate-in slide-in-from-right duration-300">
               {/* Day Selector (Reuse logic) */}
               <Card3D className="bg-[#F3E5F5]">
                  <div className="flex justify-between items-center mb-2">
                     <button onClick={() => setDayViewStartIndex(Math.max(0, dayViewStartIndex - 1))} className="p-2"><ChevronLeft strokeWidth={3}/></button>
                     <h2 className="text-2xl font-black text-[#6A1B9A]">{scheduleDay} ÁöÑÂõûÊÜ∂</h2>
                     <button onClick={() => setDayViewStartIndex(Math.min(tripDays.length - 3, dayViewStartIndex + 1))} className="p-2"><ChevronRight strokeWidth={3}/></button>
                  </div>
               </Card3D>

               {/* Photo Area */}
               <div className="bg-white p-4 rounded-[2rem] border-4 border-black shadow-[6px_6px_0_#B39DDB] relative">
                   <div className="w-full h-48 bg-gray-100 rounded-xl flex flex-col items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden relative group">
                      {dailyPhotos[scheduleDay] ? <img src={dailyPhotos[scheduleDay]} className="w-full h-full object-cover"/> : <><ImageIcon size={40} className="text-gray-300"/><span className="text-gray-400 font-bold mt-2">Ë≤ºÂºµÁÖßÁâáÂêß</span></>}
                      <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>{
                         const file=e.target.files[0]; if(!file)return;
                         const reader=new FileReader(); reader.onload=async()=>{ await setDoc(doc(db,'artifacts',appId,'users',user.uid,'daily_photos',scheduleDay),{image:reader.result}); }; reader.readAsDataURL(file);
                      }}/>
                   </div>
                   <div className="absolute -top-3 -right-3 rotate-12 bg-yellow-300 text-black px-3 py-1 font-black border-2 border-black rounded-lg shadow-sm">Photo!</div>
               </div>

               {/* Diary Text */}
               <Card3D className="bg-white">
                  <div className="flex justify-between mb-2">
                     <h3 className="font-black text-xl flex items-center"><PenTool className="mr-2"/> Êó•Ë®òÂÖßÂÆπ</h3>
                     <button onClick={handleAiDiary} className="bg-[#BA68C8] text-white px-3 py-1 rounded-lg font-bold text-xs border-2 border-black shadow-[2px_2px_0_#000] flex items-center">
                        {isGeneratingDiary ? <Loader2 className="animate-spin mr-1"/> : <Sparkles size={14} className="mr-1"/>} AI Âπ´ÊàëÂØ´
                     </button>
                  </div>
                  <textarea 
                     value={diaryText} 
                     onChange={e=>setDiaryText(e.target.value)} 
                     className="w-full h-40 bg-[#F3E5F5] rounded-xl border-2 border-[#CE93D8] p-4 text-lg font-bold focus:outline-none focus:border-[#AB47BC]" 
                     placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºÂ•ΩÁé©ÁöÑ‰∫ãÔºü"
                  />
                  <button onClick={handleSaveDiary} className="bg-[#8E24AA] w-full mt-4 text-white font-black py-3 px-5 rounded-2xl border-b-[6px] border-black/20 active:border-b-0 active:translate-y-[6px] shadow-lg transition-all">‰øùÂ≠òÂõûÊÜ∂</button>
               </Card3D>
            </div>
          )}
          
        </div>
      </main>

      {/* SETTINGS MODAL */}
      {showSettingsModal && (
         <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setShowSettingsModal(false)}>
            <Card3D className="w-full max-w-sm max-h-[80vh] overflow-y-auto relative" onClick={e=>e.stopPropagation()}>
               <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-black">‚öôÔ∏è Ë®≠ÂÆö‰∏≠ÂøÉ</h2>
                  <button onClick={()=>setShowSettingsModal(false)}><X strokeWidth={3}/></button>
               </div>
               <div className="space-y-4">
                  <div>
                     <label className="font-bold block mb-1">üí∞ Á∏ΩÈ†êÁÆó</label>
                     <input type="number" value={totalBudget} onChange={e=>{setTotalBudget(e.target.value);saveSettings({totalBudget:e.target.value})}} className="w-full border-2 border-black rounded-xl p-2 font-bold"/>
                  </div>
                  {/* Demo Button */}
                  <div className="border-t-2 border-dashed border-gray-300 pt-4">
                     <button onClick={loadDemo} className="w-full py-3 bg-[#FFEB3B] border-2 border-black rounded-xl font-black shadow-[3px_3px_0_#000] flex items-center justify-center hover:translate-y-1 hover:shadow-none transition-all"><Database className="mr-2"/> ‰∏ÄÈçµÂåØÂÖ•ÁØÑ‰æãË≥áÊñô</button>
                     <p className="text-xs text-gray-400 text-center mt-2">‚Äª Á¨¨‰∏ÄÊ¨°‰ΩøÁî®Êé®Ëñ¶ÔºÅ</p>
                  </div>
                  {/* Reset Button */}
                  <div className="border-t-2 border-dashed border-gray-300 pt-4">
                     <button onClick={()=>{if(window.confirm('Á¢∫ÂÆöÊ∏ÖÁ©∫ÊâÄÊúâË≥áÊñôÔºü')) {setTransactions([]); setSchedule([]); setShoppingList([]); alert("Â∑≤Ê∏ÖÁ©∫");}}} className="w-full py-3 bg-red-100 text-red-500 border-2 border-red-200 rounded-xl font-black flex items-center justify-center"><Trash2 className="mr-2"/> ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
                  </div>
               </div>
            </Card3D>
         </div>
      )}

      {/* IMPORT MODAL */}
      {showImportModal && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setShowImportModal(false)}><Card3D className="w-full max-w-sm"><h2 className="text-xl font-black mb-4">ÂåØÂÖ•Ê∏ÖÂñÆ</h2><textarea value={importText} onChange={e=>setImportText(e.target.value)} className="w-full h-32 border-2 border-black rounded-xl p-2 font-bold mb-4" placeholder="Ë≤º‰∏äÊñáÂ≠ó..."/><button onClick={async()=>{const l=importText.split('\n').filter(x=>x.trim());await Promise.all(l.map(i=>addDoc(collection(db,'artifacts',appId,'users',user.uid,'shopping_list'),{item:i,isBought:false})));setShowImportModal(false);}} className="w-full bg-[#FFCC00] text-white font-black py-3 rounded-xl border-2 border-black shadow-[4px_4px_0_#000]">ÂåØÂÖ•</button></Card3D></div>}
      
      {/* CALCULATOR MODAL */}
      {showCalculatorModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setShowCalculatorModal(false)}>
           <Card3D className="w-full max-w-sm">
              <h2 className="text-xl font-black mb-4 flex items-center"><Calculator className="mr-2"/> ÂåØÁéáË©¶ÁÆó</h2>
              <div className="space-y-4">
                 <div><label className="font-bold">ÂåØÁéá</label><input type="number" value={calcRate} onChange={e=>setCalcRate(e.target.value)} className="w-full border-2 border-black rounded-xl p-2 font-bold"/></div>
                 <div><label className="font-bold">Â§ñÂπ£</label><input type="number" value={calcAmount} onChange={e=>setCalcAmount(e.target.value)} className="w-full border-2 border-black rounded-xl p-2 font-bold"/></div>
                 <div className="bg-gray-100 p-4 rounded-xl text-center border-2 border-black">
                    <div className="text-sm text-gray-500 font-bold">Á¥ÑÂè∞Âπ£</div>
                    <div className="text-3xl font-black">NT$ {Math.round(calcAmount * calcRate)}</div>
                 </div>
                 <button onClick={()=>{const r=Math.round(calcAmount*calcRate);setCalcResult(r)}} className="w-full bg-[#00BCD4] text-white font-black py-3 rounded-xl border-2 border-black shadow-[4px_4px_0_#000]">Ë®àÁÆó</button>
              </div>
           </Card3D>
        </div>
      )}

    </div>
  );
}
